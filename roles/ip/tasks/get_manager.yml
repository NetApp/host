- name: Determine network management tools
  block:
    - name: Get systemd services
      ansible.builtin.service_facts:
      become: true

    - name: Determine whether netplan is installed.
      ansible.builtin.shell: command -v netplan
      register: netplan
      changed_when: false
      failed_when: false
      become: true

    - name: Determine whether ifupdown or compatible tool is installed.
      ansible.builtin.shell: command -v ifup
      register: ifupdown
      changed_when: false
      failed_when: false
      become: true

    - name: Determine whether nmcli is installed.
      ansible.builtin.shell: command -v nmcli
      register: nmcli
      changed_when: false
      failed_when: false
      become: true

    - name: Populate eseries_ip_manager list.
      ansible.builtin.set_fact:
        eseries_ip_manager_tools: |-
          {%- set managers = [] -%}
          {%- if netplan["rc"] == 0 -%}
            {%- if managers.append("netplan") -%}{%- endif -%}
          {%- endif -%}
          {%- if nmcli["rc"] == 0 -%}
            {%- if managers.append("nmcli") -%}{%- endif -%}
          {%- endif -%}
          {%- if ifupdown["rc"] == 0 -%}
            {%- if managers.append("ifupdown") -%}{%- endif -%}
          {%- endif -%}
          {%- if ansible_facts["services"]["NetworkManager.service"] is defined and
                 (ansible_facts["services"]["NetworkManager.service"]["state"] == "running" or
                  ansible_facts["services"]["NetworkManager.service"]["status"] == "enabled") -%}
            {%- if managers.append("network_manager") -%}{%- endif -%}
          {%- endif -%}
          {%- if ansible_facts["services"]["systemd-networkd.service"] is defined and
                 (ansible_facts["services"]["systemd-networkd.service"]["state"] == "running" or
                  ansible_facts["services"]["systemd-networkd.service"]["status"] == "enabled") -%}
            {%- if managers.append("networkd") -%}{%- endif -%}
          {%- endif -%}
          {{- managers -}}
  when: eseries_ip_manager_tools is not defined

- name: Determine whether Netplan or ifupdown or nmcli are installed.
  ansible.builtin.fail:
    msg: "Netplan and ifupdown and nmcli compatible tool are installed or not installed! Remove the one you are not using or define eseries_ip_manager_tools in your inventory."
  when: '("netplan" in eseries_ip_manager_tools and "ifupdown" in eseries_ip_manager_tools) or ("netplan" not in eseries_ip_manager_tools and "ifupdown" not in eseries_ip_manager_tools))'

- name: Determine whether NetworkManager or systemd-networkd are installed.
  ansible.builtin.fail:
    msg: "NetworkManager and systemd-networkd are both installed or not installed! Remove the one you are not using or define eseries_ip_manager_tools in your inventory."
  when: '("network_manager" in eseries_ip_manager_tools and "networkd" in eseries_ip_manager_tools) or ("network_manager" not in eseries_ip_manager_tools and "networkd" not in eseries_ip_manager_tools))'