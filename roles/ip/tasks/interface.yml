- name: Check interface definitions.
  ansible.builtin.fail:
    msg: "Interface(s) are missing required information! Required keys: [ {{- eseries_ip_interface_required_keys | join(', ') -}} ]. Definitions missing required keys: [ {{- invalid_interfaces | join(', ') -}} ]"
  when: invalid_interfaces | length > 0
  vars:
    invalid_interfaces: |-
      {%- set interfaces = [] -%}
      {%- for interface in eseries_ip_interfaces -%}
        {%- set keys = interface.keys() | list -%}
        {%- for required_key in eseries_ip_interface_required_keys if required_key not in keys -%}
          {%- if interfaces.append(interface) -%}{%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
      {{- interfaces -}}

# Ansible has a hard limitation where only the parent and the parent-parent role defaults are available to a role's
#   tasks. As a temporary workaround, the _common_udev_X variables are set then cleared to prevent overriding user-defined
#   inventory.
- name: Configure persistent network interface names.
  block:
    - name: Set facts required for configuring persistent network interface names.
      ansible.builtin.set_fact:
        _common_udev_name: "{{ eseries_ip_udev_name }}"
        _common_udev_rules: "{{ eseries_ip_udev_rules }}"

    - name: Configure persistent network interface names.
      ansible.builtin.include_role:
        name: netapp_eseries.host.common
        tasks_from: interface/rename_rules/apply.yml

    - name: Clear facts required for configuring persistent network interface names.
      ansible.builtin.set_fact:
        _common_udev_name: ""
        _common_udev_rules: ""

- name: Configure interfaces using ifupdown configuration.
  ansible.builtin.include_tasks: interface/ifupdown.yml
  when: '"ifupdown" in eseries_ip_manager_tools'

- name: Configure interfaces using netplan configuration.
  ansible.builtin.include_tasks: interface/netplan.yml
  when: '"netplan" in eseries_ip_manager_tools'

- name: Install any Network Manager dispatcher hooks.
  ansible.builtin.include_tasks: interface/hook/network_manager.yml
  when: '"network_manager" in eseries_ip_manager_tools'

- name: Apply any interface firewall changes.
  ansible.builtin.include_tasks: interface/firewall_zone/apply.yml
  when: eseries_ip_configure_firewall
