- name: Install InfiniBand OpenSM custom packages.
  include_role:
    name: common
    tasks_from: installer/install.yml
  when: '"install" in (eseries_common_custom_packages.keys() | list)'
  vars:
    eseries_common_package_group: "InfiniBand OpenSM"
    eseries_common_custom_packages: "{{ eseries_ib_opensm_custom_packages | default({}) }}"
    eseries_common_allow_upgrades: "{{ eseries_ib_opensm_allow_upgrades | default(false) }}"
    eseries_common_skip_package_validation: "{{ eseries_ib_opensm_skip_package_validation | default(false) }}"

- name: Load operating system specific variables.
  include_vars: "{{ ansible_os_family | lower }}.yml"

- name: Ensure InfiniBand OpenSM packages are installed.
  include_tasks: "package/{{ ansible_os_family | lower }}.yml"

- name: Ensure InfiniBand OpenSM subnet managers are configured.
  include_tasks: configure.yml

- name: Uninstall InfiniBand OpenSM subnet managers.
  block:
    - name: Install InfiniBand base custom packages.
      include_role:
        name: common
        tasks_from: installer/uninstall.yml
      when: '"uninstall" in (eseries_common_custom_packages.keys() | list)'
      vars:
        eseries_common_package_group: "InfiniBand OpenSM"
        eseries_common_custom_packages: "{{ eseries_ib_base_custom_packages | default({}) }}"
        eseries_common_allow_upgrades: "{{ eseries_ib_base_allow_upgrades | default(false) }}"
        eseries_common_skip_package_validation: "{{ eseries_ib_base_skip_package_validation | default(false) }}"

    - name: Uninstall InfiniBand OpenSM subnet managers.
      include_tasks: uninstall.yml
  when: eseries_common_force_skip_uninstall == False
  tags:
    - never
    - ib_opensm_uninstall
