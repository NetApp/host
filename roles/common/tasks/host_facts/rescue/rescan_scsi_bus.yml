- name: Rescan iSCSI sessions
  command: "iscsiadm -m session --rescan"
  failed_when: false
  become: true
  when: "'rescan_iscsi_sessions' in rescan_actions"

- name: Rescan for all SCSI devices.
  shell: "{{ item }}"
  become: true
  failed_when: false
  loop:
    - "for x in $(ls /sys/class/scsi_host); do echo '- - -' > /sys/class/scsi_host/$x/scan; done &> /dev/null"
    - "for x in $(ls /sys/block); do echo 1 > /sys/block/$x/device/rescan; done &> /dev/null"

- name: Reload multipath
  command:
    cmd: multipath -W
  failed_when: false
  become: true

- name: Reconfigure multipath
  command:
    cmd: multipathd reconfigure
  failed_when: false
  become: true
